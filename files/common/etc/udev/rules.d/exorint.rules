# There are a number of modifiers that are allowed to be used in some
# of the different fields. They provide the following subsitutions:
#
# %n the "kernel number" of the device.
#    For example, 'sda3' has a "kernel number" of '3'
# %e the smallest number for that name which does not matches an existing node
# %k the kernel name for the device
# %M the kernel major number for the device
# %m the kernel minor number for the device
# %b the bus id for the device
# %c the string returned by the PROGRAM
# %s{filename} the content of a sysfs attribute
# %% the '%' char itself
#

#
# File System
#

# USB stick automounting
KERNEL=="sda1", SUBSYSTEMS=="usb", ENV{myname}="usbmemory"
KERNEL=="sda[2-9]", SUBSYSTEMS=="usb", ENV{myname}="usbmemoryp%n"
KERNEL=="sdb1", SUBSYSTEMS=="block", ENV{myname}="usbmemory2"
KERNEL=="sdb[2-9]", SUBSYSTEMS=="usb", ENV{myname}="usbmemory2p%n"
KERNEL=="sdc1", SUBSYSTEMS=="usb", ENV{myname}="usbmemory3"
KERNEL=="sdc[2-9]", SUBSYSTEMS=="usb", ENV{myname}="usbmemory3p%n"
KERNEL=="sdd1", SUBSYSTEMS=="usb", ENV{myname}="usbmemory4"
KERNEL=="sdd[2-9]", SUBSYSTEMS=="usb", ENV{myname}="usbmemory4p%n"
KERNEL=="sd?[1-9]", SUBSYSTEMS=="usb", ACTION=="add",    RUN+="/etc/udev/scripts/mount.sh"
KERNEL=="sd?[1-9]", SUBSYSTEMS=="usb", ACTION=="remove", RUN+="/etc/udev/scripts/mount.sh"

# USB stick autorun
SUBSYSTEM=="block", KERNEL=="sda1", ACTION=="add", RUN+="/etc/udev/scripts/usb_autorun.sh usbmemory"
SUBSYSTEM=="block", KERNEL=="sdb1", ACTION=="add", RUN+="/etc/udev/scripts/usb_autorun.sh usbmemory2"
SUBSYSTEM=="block", KERNEL=="sdc1", ACTION=="add", RUN+="/etc/udev/scripts/usb_autorun.sh usbmemory3"

# auto-mount EMMC
ACTION=="add", KERNEL=="mmcblk1p[0-5]", SUBSYSTEM=="block", RUN+="/etc/udev/scripts/mount.sh"
ACTION=="add", KERNEL=="mmcblk1p6", SUBSYSTEM=="block", RUN+="/etc/udev/scripts/mount.sh", \
    RUN+="/etc/udev/scripts/datapart_setup.sh"
ACTION=="remove", KERNEL=="mmcblk1p[0-6]", SUBSYSTEM=="block", RUN+="/etc/udev/scripts/mount.sh"

# Auto-mount any SD card
KERNEL=="mmcblk0p1", SUBSYSTEM=="block", ENV{myname}="sdcard"
KERNEL=="mmcblk0p[2-9]", SUBSYSTEM=="block", ENV{myname}="sdcardp%n"
ACTION=="add", KERNEL=="mmcblk0p[0-9]", SUBSYSTEM=="block", RUN+="/etc/udev/scripts/mount.sh"
ACTION=="remove", KERNEL=="mmcblk0p[0-9]", SUBSYSTEM=="block", RUN+="/etc/udev/scripts/mount.sh"

#
# Communication
#

# Create a symlink to the pwm-beeper input device
SUBSYSTEMS=="input", KERNEL=="event[0-9]*", KERNELS=="input[0-9]*", ATTRS{name}=="pwm-beeper", SYMLINK+="input/beeper"

# Create symlinks for uart ports (dev/ttyO0 -> dev/com1, dev/ttyO1 -> dev/com2, ...)
KERNEL=="ttyO0", SUBSYSTEM=="tty", SYMLINK="com1"
KERNEL=="ttyO1", SUBSYSTEM=="tty", SYMLINK="com2"
KERNEL=="ttyO2", SUBSYSTEM=="tty", SYMLINK="com3"
KERNEL=="ttyO3", SUBSYSTEM=="tty", SYMLINK="com4"
KERNEL=="ttyO4", SUBSYSTEM=="tty", SYMLINK="com5"

# All other communication devices belong to 'comm' group (also plain 'user' belongs to it)
KERNEL=="gpio*", PROGRAM="/bin/sh -c '\
    /bin/chgrp -R comm /sys/class/gpio; /bin/chmod -R 770 /sys/class/gpio; \
    /bin/chgrp -R comm /sys/devices/virtual/gpio; /bin/chmod -R 770 /sys/devices/virtual/gpio; \
    '"
SUBSYSTEM=="spidev", GROUP="comm", MODE="0660"
SUBSYSTEM=="i2c-dev", GROUP="comm", MODE="0660"

#
# Video
#

SUBSYSTEM=="backlight", RUN+="/bin/chgrp video /sys/class/backlight/%k/brightness /sys/class/backlight/%k/bl_power", \
    RUN+="/bin/chmod 664 /sys/class/backlight/%k/brightness /sys/class/backlight/%k/bl_power"
